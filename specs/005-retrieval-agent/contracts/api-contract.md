# API Contract: Retrieval-Enabled Agent Service

## Base Information
- **Base URL**: `/api/v1` (or configurable)
- **Content-Type**: `application/json`
- **Authentication**: Bearer token (if required) or API key in headers

## Endpoints

### 1. Ask Endpoint
**Path**: `POST /ask`
**Description**: Accepts user questions and returns sourced answers based on book content

#### Request
```json
{
  "query": "string (required) - The question to ask",
  "session_id": "string (optional) - Session identifier for maintaining context",
  "user_id": "string (optional) - User identifier"
}
```

#### Response (Success - 200 OK)
```json
{
  "response_id": "string - Unique identifier for the response",
  "answer": "string - The answer generated by the agent",
  "sources": [
    {
      "chunk_id": "string - Unique identifier for the retrieved chunk",
      "content": "string - Content of the retrieved chunk",
      "url": "string - Source URL of the content",
      "position": "integer - Position in the original document",
      "relevance_score": "float - Similarity score"
    }
  ],
  "query_id": "string - Reference to the original query",
  "timestamp": "string - ISO 8601 formatted timestamp",
  "confidence_score": "float - Estimated confidence in the answer"
}
```

#### Response (Error - 400 Bad Request)
```json
{
  "error": "string - Error message describing the issue",
  "error_code": "string - Code identifying the type of error"
}
```

### 2. Health Check Endpoint
**Path**: `GET /health`
**Description**: Checks the health status of the agent service and its dependencies

#### Response (Success - 200 OK)
```json
{
  "status": "string - Overall health status (e.g., 'healthy', 'degraded', 'unhealthy')",
  "timestamp": "string - ISO 8601 formatted timestamp",
  "services": {
    "openai": {
      "status": "string - Status of OpenAI service (e.g., 'available', 'unavailable')",
      "response_time_ms": "number - Response time in milliseconds"
    },
    "qdrant": {
      "status": "string - Status of Qdrant service (e.g., 'available', 'unavailable')",
      "response_time_ms": "number - Response time in milliseconds"
    },
    "cohere": {
      "status": "string - Status of Cohere service (e.g., 'available', 'unavailable')",
      "response_time_ms": "number - Response time in milliseconds"
    }
  },
  "details": {
    "uptime_seconds": "number - Seconds since the service started",
    "active_sessions": "number - Number of active agent sessions",
    "version": "string - Version of the service"
  }
}
```

### 3. Agent Run Endpoint
**Path**: `POST /agent/run`
**Description**: Executes an agent run programmatically with custom instructions

#### Request
```json
{
  "instructions": "string (required) - Instructions for the agent",
  "input_data": "object (optional) - Additional data to provide to the agent",
  "session_id": "string (optional) - Session identifier for maintaining context",
  "tools": [
    "string - List of specific tools the agent should be allowed to use"
  ],
  "model": "string (optional) - Specific model to use (default will be used if not specified)"
}
```

#### Response (Success - 200 OK)
```json
{
  "run_id": "string - Unique identifier for the agent run",
  "status": "string - Current status of the run (e.g., 'completed', 'running', 'failed')",
  "output": "string - Output generated by the agent",
  "timestamp": "string - ISO 8601 formatted timestamp",
  "execution_time_ms": "number - Time taken to execute the run in milliseconds",
  "tool_calls": [
    {
      "tool_name": "string - Name of the tool called",
      "input": "object - Input provided to the tool",
      "output": "object - Output received from the tool"
    }
  ]
}
```

## Error Responses

All endpoints may return the following standard error responses:

### 500 Internal Server Error
```json
{
  "error": "string - Error message describing the server issue",
  "error_code": "string - Code identifying the type of error",
  "timestamp": "string - ISO 8601 formatted timestamp"
}
```

### 429 Rate Limit Exceeded
```json
{
  "error": "Rate limit exceeded",
  "retry_after": "number - Seconds to wait before retrying",
  "error_code": "RATE_LIMIT_EXCEEDED"
}
```

## Common Headers

All requests and responses may include these headers:
- `X-Request-ID`: Unique identifier for the request
- `X-Session-ID`: Session identifier for tracking conversation context
- `Content-Type`: `application/json`

## Authentication

Some endpoints may require authentication using:
- Header: `Authorization: Bearer <token>`
- Or: `X-API-Key: <api_key>`

## Rate Limiting

Requests may be rate-limited based on the following criteria:
- Per IP address: 100 requests per minute
- Per API key: 1000 requests per minute
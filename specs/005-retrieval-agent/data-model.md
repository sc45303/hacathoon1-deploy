# Data Model: Retrieval-Enabled Agent with OpenAI Agents SDK + FastAPI

## Core Entities

### UserQuery
- **query_id**: string - Unique identifier for the query
- **text**: string - The natural language question submitted by the user
- **timestamp**: datetime - When the query was submitted
- **user_id**: string? - Optional identifier for the user making the query
- **session_id**: string? - Optional identifier for tracking conversation context

### RetrievedChunk
- **chunk_id**: string - Unique identifier for the retrieved text chunk
- **content**: string - The text content of the retrieved chunk
- **url**: string - The source URL of the content in the book
- **position**: integer - The position of the chunk in the original document
- **relevance_score**: float - Similarity score from the retrieval process
- **source_metadata**: dict - Additional metadata about the source document

### AgentResponse
- **response_id**: string - Unique identifier for the response
- **content**: string - The final answer generated by the agent
- **query_id**: string - Reference to the original user query
- **chunks_used**: list[RetrievedChunk] - List of chunks that were used to generate the response
- **timestamp**: datetime - When the response was generated
- **confidence_score**: float? - Estimated confidence in the response accuracy

### AgentSession
- **session_id**: string - Unique identifier for the agent session
- **created_at**: datetime - When the session was created
- **last_interaction**: datetime - When the last interaction occurred
- **status**: enum(active, completed, expired) - Current status of the session
- **history**: list[dict] - List of previous interactions in the session

### APIRequest
- **endpoint**: string - The endpoint being called (e.g., "/ask", "/health", "/agent/run")
- **method**: enum(GET, POST, PUT, DELETE) - HTTP method used
- **params**: dict - Parameters passed to the endpoint
- **headers**: dict - HTTP headers for the request
- **timestamp**: datetime - When the request was made

### APIResponse
- **request_id**: string - Reference to the original API request
- **status_code**: integer - HTTP status code returned
- **content**: dict - Response data returned by the API
- **timestamp**: datetime - When the response was generated
- **processing_time**: float - Time taken to process the request in seconds

## Relationships

- A `UserQuery` generates one `AgentResponse`
- An `AgentResponse` references multiple `RetrievedChunk` objects
- Multiple `UserQuery` and `AgentResponse` pairs can belong to one `AgentSession`
- An `APIRequest` results in one `APIResponse`
- An `APIRequest` can trigger a sequence of `UserQuery` processing

## Validation Rules

### From Functional Requirements

- **FR-001**: System MUST provide a FastAPI backend for the Agent runtime
  - API requests and responses must follow the defined schema

- **FR-002**: System MUST implement an Agent using OpenAI Agents SDK that can process user queries
  - User queries must have the required fields for agent processing

- **FR-003**: System MUST provide a custom retrieval tool that connects to Qdrant
  - Retrieved chunks must contain all required metadata fields

- **FR-004**: System MUST fetch the most relevant text chunks from Qdrant based on query embeddings
  - Retrieved chunks must include relevance scores and content

- **FR-005**: System MUST provide an `/ask` endpoint that accepts user questions and returns sourced answers
  - Request schema must include query text
  - Response schema must include answer and sourced chunks

- **FR-006**: System MUST provide a `/health` endpoint to check system status
  - Response must include status of all dependencies (OpenAI, Qdrant, Cohere)

- **FR-007**: System MUST provide an `/agent/run` endpoint for programmatic agent execution
  - Request schema must include agent instructions and parameters

- **FR-008**: System MUST ensure all responses are grounded exclusively in retrieved book content
  - Agent responses must reference the retrieved chunks used in their creation

### Success Criteria Compliance

- **SC-003**: The `/ask` endpoint returns accurate, sourced responses based on book chunks for 90%+ of queries
  - Each response must include a reference to the retrieved chunks it's based on
# Data Model: Unified Agentic RAG Chatbot System

## Core Entities

### Query
- **Description**: A user's question with optional parameters representing the input to the system
- **Fields**:
  - `question` (string): The user's question text
  - `selected_text` (string, optional): Specific text selected by the user from the book (when present, triggers selected-text mode)
  - `mode` (enum: "selected_text", "book", "general", optional): Explicit mode specification from the user
- **Validation**:
  - `question` is required and must not be empty
  - If `selected_text` is provided, it must not exceed token limits for LLM context window

### Agent Router
- **Description**: The central decision-making component that classifies and routes queries to appropriate answering strategies
- **Fields**:
  - `query` (Query): The input query to process
  - `classification_result` (enum: "selected_text", "book", "general"): The determined query type
  - `routing_strategy` (enum: "selected_text_only", "rag_delegation", "llm_completion"): The strategy to use for answering
- **State Transitions**:
  - `received` → `classified` → `routed` → `answered` → `response_formatted`

### Query Mode
- **Description**: The classification of a query as one of three types
- **Values**:
  - `selected_text`: Query should be answered only from provided selected text
  - `book`: Query should be answered using book RAG pipeline
  - `general`: Query should be answered using general LLM completion

### Answer
- **Description**: The response generated by the appropriate answering strategy based on the query mode
- **Fields**:
  - `content` (string): The answer text generated by the system
  - `mode` (enum: "selected_text", "book", "general"): The mode used to generate this answer
  - `sources` (array of objects): Document references or citations that support the answer (primarily used for book-related queries)
- **Validation**:
  - `content` is required and must not be empty
  - `mode` must match the mode that was used to generate the answer
  - `sources` array must be empty for "selected_text" and "general" modes

### Source
- **Description**: A document reference or citation that supports the answer, primarily used for book-related queries
- **Fields**:
  - `document_id` (string): Unique identifier for the source document
  - `content` (string): The text content from the source document
  - `page_number` (integer, optional): The page number in the source document
  - `section_title` (string, optional): The title of the section in the source document
- **Validation**:
  - `document_id` and `content` are required for book-related answers
  - For selected-text mode, sources should be derived only from the provided selected text

### Answering Strategy
- **Description**: The method used to generate the answer, which varies based on the query mode
- **Types**:
  - `selected-text-only`: Uses strict prompt rules: "answer only from provided text"
  - `rag-based`: Reuses the existing RAG pipeline to retrieve relevant information from book content
  - `general-llm-completion`: Uses direct LLM completion without retrieval